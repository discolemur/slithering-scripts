#! /usr/bin/env python

import glob
import argparse

"""
 branch          t       N       S   dN/dS      dN      dS  N*dN  S*dS

  21..22     0.000   473.1   183.9  0.0001  0.0000  0.0000   0.0   0.0
  22..23     0.059   473.1   183.9  0.0001  0.0000  0.0705   0.0  13.0
  23..24     0.127   473.1   183.9  0.0435  0.0059  0.1361   2.8  25.0
  24..25     0.120   473.1   183.9  0.0925  0.0107  0.1157   5.1  21.3
  25..2      0.170   473.1   183.9  0.0222  0.0042  0.1915   2.0  35.2
  25..26     0.304   473.1   183.9  0.0121  0.0042  0.3505   2.0  64.5
  26..12     0.055   473.1   183.9  0.0001  0.0000  0.0652   0.0  12.0
  26..19     0.002   473.1   183.9  0.0001  0.0000  0.0029   0.0   0.5
  24..13     0.163   473.1   183.9  0.0356  0.0063  0.1782   3.0  32.8
  23..27     0.325   473.1   183.9  0.0182  0.0067  0.3702   3.2  68.1
  27..3      0.028   473.1   183.9  0.0001  0.0000  0.0331   0.0   6.1
  27..17     0.017   473.1   183.9  0.4377  0.0041  0.0094   1.9   1.7
  22..28     0.304   473.1   183.9  0.0593  0.0186  0.3141   8.8  57.8
  28..10     0.000   473.1   183.9  0.0001  0.0000  0.0000   0.0   0.0
  28..9      0.005   473.1   183.9  0.0001  0.0000  0.0060   0.0   1.1
  21..29     0.387   473.1   183.9  0.0103  0.0046  0.4493   2.2  82.6
  29..16     0.282   473.1   183.9  0.0001  0.0000  0.3351   0.0  61.6
  29..30     0.201   473.1   183.9  0.0382  0.0083  0.2182   3.9  40.1
  30..31     0.067   473.1   183.9  0.0277  0.0021  0.0748   1.0  13.8
  31..32     0.217   473.1   183.9  0.0168  0.0042  0.2476   2.0  45.5
  32..7      0.044   473.1   183.9  0.1005  0.0042  0.0418   2.0   7.7
  32..33     0.036   473.1   183.9  0.0001  0.0000  0.0434   0.0   8.0
  33..8      0.028   473.1   183.9  0.0001  0.0000  0.0330   0.0   6.1
  33..34     0.004   473.1   183.9  0.0001  0.0000  0.0053   0.0   1.0
  34..15     0.011   473.1   183.9  0.0001  0.0000  0.0127   0.0   2.3
  34..11     0.025   473.1   183.9  0.0001  0.0000  0.0295   0.0   5.4
  31..35     0.043   473.1   183.9  0.0001  0.0000  0.0511   0.0   9.4
  35..5      0.163   473.1   183.9  0.0226  0.0041  0.1837   2.0  33.8
  35..36     0.027   473.1   183.9  0.0001  0.0000  0.0327   0.0   6.0
  36..18     0.068   473.1   183.9  0.0273  0.0021  0.0755   1.0  13.9
  36..6      0.115   473.1   183.9  0.0328  0.0042  0.1267   2.0  23.3
  30..37     0.209   473.1   183.9  0.0465  0.0103  0.2219   4.9  40.8
  37..4      0.000   473.1   183.9  0.0001  0.0000  0.0000   0.0   0.0
  37..1      0.005   473.1   183.9  0.0001  0.0000  0.0061   0.0   1.1
  21..38    49.999   473.1   183.9  0.0015  0.0915 59.2945  43.3 10906.5
  38..20    50.000   473.1   183.9  0.0009  0.0553 59.3887  26.1 10923.9
  38..14    50.000   473.1   183.9  0.0008  0.0499 59.4024  23.6 10926.4

tree length for dN:       0.3018
"""

# OutPAML.cluster100_bin20.aln.gapfiltered.fasta

def add_file(file, table) :
    name = file[8:].replace('.gapfiltered.fasta','')
    fh = open(file, 'r')
    get = False
    for line in fh :
        line = line.strip()
        if len(line) == 0 :
            continue
        if line[:4] == 'tree' :
            get = False
        if get :
            line = '%s\t%s' %(name, '\t'.join(line.split()))
            table.append(line)
        elif line[:6] == 'branch' :
            get = True
    fh.close()

def main() :
    table = []
    table.append('ClusterID\tbranch\tt\tN\tS\tdN/dS\tdN\tdS\tN*dN\tS*dS')
    for file in glob.glob('OutPAML.*') :
        add_file(file, table)
    ofh = open('PAML_tables.txt', 'w')
    for line in table :
        ofh.write('%s\n' %line)
    ofh.close()

if __name__ == '__main__' :
    main()
    print('Done.')

